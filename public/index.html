<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>üé° Check in nh·∫≠n qu√† li·ªÅn tay</title>
    <style>
      body {
        font-family: Verdana, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: linear-gradient(135deg, #ff9a9e, #fad0c4, #fbc2eb);
        background-size: 600% 600%;
        animation: gradientBG 15s ease infinite;
        padding: 20px;
      }
      @keyframes gradientBG {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      h2 {
        color: #fff;
        text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        text-align: center;
        margin-bottom: 30px;
      }

      /* Container 2 c·ªôt */
      .container {
        display: flex;
        gap: 50px;
        align-items: flex-start;
        justify-content: center;
        flex-wrap: wrap;
      }

      /* Form */
      #playerForm {
        display: flex;
        flex-direction: column;
        gap: 15px;
        background: rgba(255, 255, 255, 0.9);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        min-width: 280px;
      }

      #playerForm label {
        font-weight: 600;
      }
      #playerForm input {
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        outline: none;
      }
      #playerForm input:focus {
        border-color: #ff6a6a;
        box-shadow: 0 0 5px rgba(255, 106, 106, 0.5);
      }
      #playerForm button {
        padding: 12px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(45deg, #ff6a6a, #ffb86a);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      #playerForm button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      /* V√≤ng quay */
      .wheel-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        background: rgba(255, 255, 255, 0.9);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }
      canvas {
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      }
      #spinBtn {
        padding: 12px 25px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(45deg, #ff6a6a, #ffb86a);
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      #spinBtn:disabled {
        background: #aaa;
        cursor: not-allowed;
      }
      #spinBtn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      @media (max-width: 900px) {
        .container {
          flex-direction: column;
          align-items: center;
          gap: 30px;
        }
      }
    </style>
  </head>
  <body>
    <h2>üéÅ Check in ngay nh·∫≠n qu√† li·ªÅn tay - Minigame üéÅ</h2>

    <div class="container">
      <form id="playerForm">
        <label for="name">T√™n c·ªßa b·∫°n:</label>
        <input type="text" id="name" placeholder="Nh·∫≠p t√™n" required />
        <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
        <input
          type="tel"
          id="phone"
          placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
          required
          pattern="0[0-9]{8,10}"
          title="Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá"
        />
        <button type="submit">Check in ngay</button>
      </form>

      <div class="wheel-container">
        <canvas id="wheel" width="530" height="550"></canvas>
        <button id="spinBtn" disabled>Quay!</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.3/TweenMax.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel/Winwheel.min.js"></script>

    <script>
      const apiUrl = "/spin";
      let player = {};
      function normalizePhone(phone) {
        phone = phone.replace(/\s+/g, ""); // b·ªè kho·∫£ng tr·∫Øng
        if (phone.startsWith("0")) phone = phone.slice(1);
        return phone;
      }

      // Validate form & check phone
      document
        .getElementById("playerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("name").value.trim();
          const phone = document.getElementById("phone").value.trim();

          if (!name) {
            alert("üö´ Vui l√≤ng nh·∫≠p t√™n!");
            return;
          }
          const phoneInput = document.getElementById("phone");
          if (!phoneInput.checkValidity()) {
            alert("üö´ S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!");
            return;
          }

          try {
            const res = await fetch(
              `/check-phone?phone=${encodeURIComponent(normalizePhone(phone))}`
            );
            const data = await res.json();
            if (data.used) {
              alert("üö´ S·ªë ƒëi·ªán tho·∫°i n√†y ƒë√£ quay r·ªìi!");
              document.getElementById("spinBtn").disabled = true;
              return;
            }
          } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói server!");
            return;
          }

          player.name = name;
          player.phone = phone;
          document.getElementById("spinBtn").disabled = false;
          alert(`‚úÖ Xin ch√†o ${name}, b·∫°n c√≥ th·ªÉ quay!`);
        });

      // C·∫•u h√¨nh b√°nh xe
      const wheel = new Winwheel({
        canvasId: "wheel",
        numSegments: 6,
        outerRadius: 250,
        textFontSize: 14,
        textFontFamily: "Arial, Helvetica, sans-serif",
        textOrientation: "horizontal",
        textAlignment: "outer",
        textMargin: 15,
        segments: [
          { fillStyle: "#ff7b7b", text: "Voucher 10% cho ho√° ƒë∆°n b·∫•t k√¨" },
          { fillStyle: "#7bcaff", text: "Voucher 5% cho ho√° ƒë∆°n b·∫•t k√¨" },
          { fillStyle: "#7eff7b", text: "Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau" },
          { fillStyle: "#fff87b", text: "B·∫°n nh·∫≠n ƒë∆∞·ª£c m√≥n qu√† nh·ªè" },
          { fillStyle: "#ff7be5", text: "B·∫°n nh·∫≠n ƒë∆∞·ª£c m·ªôt ƒë√¥i t·∫•t" },
          { fillStyle: "#cccccc", text: "Voucher 200k cho Hƒê t·ª´ 400k" },
        ],
        animation: {
          type: "spinToStop",
          duration: 5,
          spins: 8,
          easing: "Power2.easeOut",
          callbackFinished: onSpinComplete,
        },
      });

      // V·∫Ω m≈©i t√™n
      const canvas = document.getElementById("wheel");
      const ctx = canvas.getContext("2d");
      function drawPointer() {
        const centerX = canvas.width / 2;
        const pointerHeight = 25;
        const pointerWidth = 20;
        ctx.save();
        ctx.translate(centerX, 0);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(-pointerWidth / 2, pointerHeight);
        ctx.lineTo(pointerWidth / 2, pointerHeight);
        ctx.closePath();
        ctx.fillStyle = "red";
        ctx.shadowColor = "rgba(0,0,0,0.3)";
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 1;
        ctx.shadowOffsetY = 1;
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "black";
        ctx.stroke();
        ctx.restore();
      }
      drawPointer();
      wheel.animation.callbackBefore = function () {
        drawPointer();
      };

      // Quay b√°nh xe
      document.getElementById("spinBtn").addEventListener("click", () => {
        wheel.stopAnimation(false); // reset animation
        wheel.rotationAngle = 0; // quay v·ªÅ g√≥c 0
        wheel.draw(); // v·∫Ω l·∫°i b√°nh xe
        wheel.animation.spins = 8; // s·ªë v√≤ng quay
        wheel.animation.duration = 5; // th·ªùi gian quay
        wheel.startAnimation(); // b·∫Øt ƒë·∫ßu quay
      });

      // Khi quay xong
      function onSpinComplete(segment) {
        const result = segment.text;
        document.getElementById("spinBtn").disabled = true;
        alert(`üéâ Ch√∫c m·ª´ng ${player.name}! B·∫°n tr√∫ng: ${result}`);

        fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: player.name,
            phone: player.phone,
            result,
          }),
        })
          .then((res) => res.json())
          .then((data) => console.log(data))
          .catch((err) => console.error(err));
      }
    </script>
  </body>
</html>
